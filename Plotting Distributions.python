{"version":"NotebookV1","origId":648841980354308,"name":"Plotting Distributions","language":"python","commands":[{"version":"CommandV1","origId":648841980354309,"guid":"190391de-dda2-438e-8ef0-478a18f0d257","subtype":"command","commandType":"auto","position":1.0,"command":"%md\n# Plotting Distributions in Databricks\n<img src='https://matplotlib.org/_static/logo2.png' />\n\nDatabricks is a powerful tool for exploring and analyzing data.  When you first open a new dataset, one of the first things you may want to\nunderstand is the distribution of numerical variables.  This resuable code shows how you can quickly view that data.","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1551385267199,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"jepeach@microsoft.com","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"04172ac9-f061-4eea-86ea-4e63d57fe269"},{"version":"CommandV1","origId":648841980354310,"guid":"d3fee919-3c8f-4d00-a787-c072c5a6cfe1","subtype":"command","commandType":"auto","position":2.0,"command":"%md\n## Load Some Data Into Spark\nFirst, we'll make a Spark dataframe.","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1551385267208,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"jepeach@microsoft.com","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a4610c5c-e0af-4588-ae95-6e4f98e6b7af"},{"version":"CommandV1","origId":648841980354311,"guid":"288cd4ce-0928-473d-b289-fe2dfb05d0e2","subtype":"command","commandType":"auto","position":3.0,"command":"# Read in sample data from a CSV file and infer the schema\ndf = spark\\\n      .read\\\n      .option(\"inferSchema\", \"true\")\\\n      .option(\"header\", \"true\")\\\n      .csv(\"/databricks-datasets/flights/departuredelays.csv\")\n\ndisplay(df)","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1551462363330,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"jepeach@microsoft.com","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"d685dbe5-fdf2-445d-90d1-99437ff64138"},{"version":"CommandV1","origId":648841980354329,"guid":"5ababd61-30fd-463c-8d97-fc5d4e0281aa","subtype":"command","commandType":"auto","position":4.0,"command":"numeric_columns = []\nnumeric_types = ['double', 'float', 'int', 'long', 'short']\n\nfor x in df.dtypes:\n  if x[1] in numeric_types:\n    numeric_columns.append(x[0])\n    \nnumeric_columns","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1551462402553,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"jepeach@microsoft.com","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"0bddcaa3-23fc-4bce-95e9-8f470f3127ac"},{"version":"CommandV1","origId":648841980354334,"guid":"a4e9efa4-0577-4ec9-8546-7b05e70dbe5b","subtype":"command","commandType":"auto","position":8.0,"command":"import numpy as np\nimport seaborn as sns\nimport matplotlib.pyplot as plt\n\ndef plot_distributions(df, cols):\n  row_count = df.count()\n  target_size = 1000000\n  \n  num_df = df.select(cols)\n  \n  # If the input dataframe is super big, sample the rows to a more manageable size.\n  if row_count > 2 * target_size:\n    fraction = target_size / row_count\n    sampled_df = num_df.sample(False, fraction)\n  else:\n    sampled_df = num_df\n  \n  sampled_df.cache()\n  \n  plot_count = len(cols)\n  counter = 1\n  \n  fig = plt.figure()\n\n  for col in cols:\n    col_name = cols[counter - 1]\n    values = np.array(sampled_df.select(col_name).collect())\n\n    # Let Seaborn plot the distribution\n    ax = plt.subplot(plot_count, 1, counter)\n    ax = sns.distplot(values)\n\n    # Add vertical lines showing the mean and +/- 1 standard deviation\n    mean = np.mean(values)\n    sigma1, sigma2 = mean - np.std(values), mean + np.std(values)\n    min, max = np.min(values), np.max(values)\n    padding = (max - min) * 0.005\n\n    ax.axvline(mean, color='#c00000', linestyle='dashed', linewidth=1)\n    ax.annotate(\"$\\mu$={:,.1f}\".format(mean), xy=(mean + padding, 0), ha='left', fontsize=10)\n\n    ax.axvline(sigma1, color='#202020', linestyle='dashed', linewidth=0.5, alpha=0.37)\n    ax.axvline(sigma2, color='#202020', linestyle='dashed', linewidth=0.5, alpha=0.37)\n\n    ax.set_title(\"Distribution  of  \\\"{}\\\"\".format(col_name), {'fontsize': '20'})\n    ax.set_ylabel('probability')\n    \n    counter += 1\n\n  fig.suptitle(\"Distribution of Numeric Values in a Spark Dataframe\", fontsize=35)\n  fig.set_dpi(96)\n  fig.set_size_inches(18, 6.5 * plot_count)\n  \n  if plot_count == 1:\n    plt.subplots_adjust(top = 0.8)\n  else:\n    plt.subplots_adjust(hspace=0.5)\n\n  return(fig)","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1551462691183,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"jepeach@microsoft.com","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"390ee7f3-f2e9-4479-99ae-2cdbd7171ff1"},{"version":"CommandV1","origId":1249780835614292,"guid":"5b6c2600-7a88-4ed9-b47a-3fdb660a7127","subtype":"command","commandType":"auto","position":3.5,"command":"%md\nLoop through all of the columns in our dataframe and identify the ones with a numeric data type.","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"072b8aea-8130-4bee-a7ae-062e9e627ce9"},{"version":"CommandV1","origId":1249780835614293,"guid":"67d58328-0c57-461a-a010-db2622921cb3","subtype":"command","commandType":"auto","position":6.0,"command":"%md\nThe next cell does the real work here.  It declares a function that accepts a Spark dataframe and the names of the columns for which we wish to plot the distribution.\nPlotting for a *really* big dataset would take a long time (and possibly crash the driver node) so, when necessary, we sample only 1,000,000 rows from the dataframe\nto use in our plots.\n\nWe use the \"[seaborn](https://seaborn.pydata.org/)\" package to create a plot of the distribution.  It includes both a histogram of the values and a plot of the\nprobability distribution curve.  We use the underlying \"matplotlib\" library's functionality to augment the histogram with vertical lines showing the mean and\none standard deviation from the mean.","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"914e30b9-dd26-4989-b867-ef394b8316b1"},{"version":"CommandV1","origId":1249780835614294,"guid":"a92c4990-07bc-485f-ba32-87e908d123cc","subtype":"command","commandType":"auto","position":9.0,"command":"%md\nNow just pass our dataframe to the function, and display the results!","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"2d142d87-bf9a-476f-939c-a9a3b175c708"},{"version":"CommandV1","origId":1249780835614295,"guid":"6238a313-a296-42b1-bf14-8a0157debe5e","subtype":"command","commandType":"auto","position":12.0,"command":"","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"a352bfdd-843d-4007-a6ee-e1c95825263f"},{"version":"CommandV1","origId":2460095387563619,"guid":"c0ff68f2-de40-47f4-a3da-b4c0cb815971","subtype":"command","commandType":"auto","position":10.0,"command":"fig = plot_distributions(df, numeric_columns)\ndisplay(fig)","commandVersion":0,"state":"error","results":null,"errorSummary":null,"error":null,"workflows":[],"startTime":0,"submitTime":1551462696037,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"jepeach@microsoft.com","latestUserId":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"iPythonMetadata":null,"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"nuid":"9fc2d6bd-43b8-4a48-8f91-9095f1aefbac"}],"dashboards":[],"guid":"59dd81be-d35a-4ab1-a87d-0e9be36eced6","globalVars":{},"iPythonMetadata":null,"inputWidgets":{}}